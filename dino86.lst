     1                                          cpu 8086
     2                                          org 0x7c00
     3 00000000 E9A200                          jmp init
     4                                  
     5                                  VRAM:   equ 0xb800
     6                                  cd:     equ 0x0fa2
     7                                  
     8                                  tick:
     9 00000003 50                              push ax
    10 00000004 53                              push bx
    11 00000005 51                              push cx
    12 00000006 52                              push dx
    13 00000007 B400                            mov ah, 0x0             ; Read clock tick into dx:bx
    14 00000009 CD1A                            int 0x1a
    15                                  .again:
    16 0000000B 52                              push dx                 ; Save dx
    17 0000000C B400                            mov ah, 0x0             ; Read again
    18 0000000E CD1A                            int 0x1a
    19 00000010 5B                              pop bx
    20 00000011 39D3                            cmp bx, dx              ; Changed?
    21 00000013 74F6                            je .again               ; Nope, tick again
    22 00000015 5A                              pop dx
    23 00000016 59                              pop cx
    24 00000017 5B                              pop bx
    25 00000018 58                              pop ax
    26 00000019 C3                              ret
    27                                  
    28                                  
    29                                  scroll:
    30 0000001A BF4001                          mov di, 0xa0*2          ; Row 3, col 1
    31 0000001D BE4201                          mov si, 0xa0*2+2        ; Row 3, col 2
    32                                   .scrrow:
    33 00000020 B94F00                          mov cx, 79
    34 00000023 F3A5                            repz movsw              ; Loop: mov words from ds:si to es:di
    35 00000025 81FFC00D                        cmp di, 0xa0*22
    36 00000029 B8200F                          mov ax, 0x0f00|' '      ; Prepare to clear col 80
    37 0000002C 7C03                            jl .fillblank
    38                                   .fillblock:
    39 0000002E B8DB07                          mov ax, 0x0700|0xdb     ; Prepare to fill a block
    40                                   .fillblank:   
    41 00000031 AB                              stosw                   ; Fill blank or block, add di by 2
    42 00000032 83C602                          add si, 0x2             
    43 00000035 81FEA20F                        cmp si, 0xa0*25+2       ; All 25 rows scrolled?
    44 00000039 75E5                            jnz .scrrow
    45                                   .testcactus:
    46 0000003B A1A20F                          mov ax, [cd]
    47 0000003E 48                              dec ax
    48 0000003F A3A20F                          mov [cd], ax            ; CD--
    49 00000042 83F800                          cmp ax, 0
    50 00000045 7D5D                            jge .scrret             ; CD >= 0 -> Cactus is too close!
    51 00000047 E440                            in al, 0x40
    52 00000049 83E007                          and ax, 0x0007          ; Generate a random 'MODE' in [0,7]
    53 0000004C 3C04                            cmp al, 0x4
    54 0000004E 7C54                            jl .scrret              ; 0,1,2,3 -> Do not draw
    55 00000050 BFB80D                          mov di, 0xa0*22-8
    56 00000053 3C06                            cmp al, 0x6
    57 00000055 7C20                            jl .drawcactusB         ; 4,5 -> MODE B
    58                                                                  ; 6,7 -> MODE A
    59                                   .drawcactusA:                  ; MODE A
    60 00000057 C705DB02                        mov word [di], 0x0200|0xdb
    61 0000005B 81EFA000                        sub di, 0xa0
    62 0000005F C705DB02                        mov word [di], 0x0200|0xdb
    63 00000063 C745FED402                      mov word [di-0x2], 0x0200|0xd4
    64 00000068 C74502BE02                      mov word [di+0x2], 0x0200|0xbe
    65 0000006D 81EFA000                        sub di, 0xa0
    66 00000071 C705DB02                        mov word [di], 0x0200|0xdb
    67 00000075 EB22                            jmp .addcd
    68                                   .drawcactusB:                  ; MODE B
    69 00000077 C705DB02                        mov word [di], 0x0200|0xdb
    70 0000007B C74502DB02                      mov word [di+0x2], 0x0200|0xdb
    71 00000080 C745FEC802                      mov word [di-0x2], 0x0200|0xc8
    72 00000085 81EFA000                        sub di, 0xa0
    73 00000089 C705DB02                        mov word [di], 0x0200|0xdb
    74 0000008D C74502DB02                      mov word [di+0x2], 0x0200|0xdb
    75 00000092 C74504BE02                      mov word [di+0x4], 0x0200|0xbe
    76 00000097 EB00                            jmp .addcd
    77                                   .addcd:
    78 00000099 E440                            in al, 0x40
    79 0000009B 83E00F                          and ax, 0x000f
    80 0000009E 83C810                          or ax, 0x10             ; Generate a random cd in [16,32)
    81 000000A1 A3A20F                          mov [cd], ax
    82                                   .scrret:
    83 000000A4 C3                              ret
    84                                  
    85                                  
    86                                  init:
    87 000000A5 B80200                          mov ax, 0x2             ; Set text mode
    88 000000A8 CD10                            int 0x10
    89 000000AA B401                            mov ah, 0x1
    90 000000AC B90726                          mov cx, 0x2607          ; Set invisible cursor
    91 000000AF CD10                            int 0x10
    92 000000B1 FC                              cld                     ; Clear dflag
    93 000000B2 B800B8                          mov ax, VRAM
    94 000000B5 8ED8                            mov ds, ax
    95 000000B7 8EC0                            mov es, ax              ; Set ds,es to vram
    96 000000B9 C706A20F5000                    mov word [cd], 80
    97                                  
    98                                  initscenery:
    99 000000BF B95000                          mov cx, 80
   100                                   .isloop:
   101 000000C2 51                              push cx
   102 000000C3 E854FF                          call scroll
   103 000000C6 59                              pop cx
   104 000000C7 E2F9                            loop .isloop
   105                                  
   106                                  title:
   107 000000C9 BFE200                          mov di, 0x00e2          ; Center of row 1
   108 000000CC BE[EF00]                        mov si, TITLE
   109 000000CF B91000                          mov cx, 16              ; Loop count = TITLE.len
   110 000000D2 B40F                            mov ah, 0x0f            ; Title color
   111                                   .tloop:
   112 000000D4 2E8A04                          mov al, byte [cs:si]    ; Get title char
   113 000000D7 AB                              stosw                   ; Move ax to ds:si
   114 000000D8 46                              inc si
   115 000000D9 E827FF                          call tick
   116 000000DC E824FF                          call tick
   117 000000DF E821FF                          call tick
   118 000000E2 E2F0                            loop .tloop
   119                                          
   120                                  s:
   121 000000E4 E81CFF                          call tick
   122 000000E7 E830FF                          call scroll
   123 000000EA EBF8                            jmp s
   124                                  
   125                                  spin:
   126 000000EC F4                              hlt
   127 000000ED EBFD                            jmp spin
   128                                  
   129                                  
   130                                  
   131 000000EF 44696E6F2038362062-     TITLE:  db "Dino 86 by Bugen"
   131 000000F8 7920427567656E     
   132                                  
   133                                  bootable:
   134 000000FF 00<rept>                        times 510-($-$$) db  0
   135 000001FE 55AA                            dw 0xaa55
